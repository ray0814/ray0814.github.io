<!DOCTYPE html>

<html>
<head>
<title>åœ°åœ–</title>
<link href="favicon.ico" rel="icon" type="image/x-icon"/>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<link href="css/leaflet.css" rel="stylesheet"/>
<link href="css/L.Control.Locate.min.css" rel="stylesheet"/>
<link href="css/Leaflet.PolylineMeasure.css" rel="stylesheet">
<link href="css/leaflet.awesome-markers.css" rel="stylesheet"/>
<link href="css/Leaflet.BigImage.css" rel="stylesheet"/>
<link href="css/Control.MiniMap.css" rel="stylesheet"/>
<link href="css/leaflet.contextmenu.css" rel="stylesheet"/>
<link href="css/leaflet.modal.css" rel="stylesheet"/>
<link href="css/leaflet-geoman.css" rel="stylesheet"/>
<link href="css/font-awesome-4.0.0.css" rel="stylesheet"/>
<link href="css/bootstrap-3.0.0.css" rel="stylesheet"/>
<link href="css/semantic-2.5.0.css" rel="stylesheet"/>
<style>
			html, body, #map {
				height: 100%;
				margin: 0;
				padding: 0;
				font-size: 95%;
			}
			.mouse-position {
				padding: 5px 10px;
				background: rgba(255, 255, 255, 0.8);
				font-size: 14px;
				font-family: Arial, sans-serif;
			}
			.toolbar {
				position: absolute;
				top: 10px;
				left: 50%;
				transform: translateX(-50%);
				background: rgba(255, 255, 255, 0.9);
				padding: 8px 12px;
				border-radius: 5px;
				box-shadow: 0 0 8px rgba(0, 0, 0, 0.2);
				z-index: 1000;
				font-family: Arial, sans-serif;
			}
			.toolbar input {
				width: 180px;
				padding: 4px 6px;
				margin-right: 6px;
				font-size: 14px;
			}
			.toolbar button {
				padding: 5px 10px;
				font-size: 14px;
				cursor: pointer;
			}
			#exportmapseg {
				display: none;
				position: absolute;
				top: 120px;
				right: 60px;
				z-index: 1000;
			}
		</style>
<script src="js/jquery-3.7.1.js" type="text/javascript"></script>
<script src="js/semantic-2.5.0.js" type="text/javascript"></script>
<script src="js/leaflet-1.9.3-src.js" type="text/javascript"></script>
<script src="js/proj4-2.19.3-src.js" type="text/javascript"></script>
<script src="js/baseLayers2.js" type="text/javascript"></script>
<script src="js/L.Control.Locate.min.js" type="text/javascript"></script>
<!-- <script type="text/javascript" src="js/leaflet-easyPrint.js"></script> -->
<script src="js/Leaflet.BigImage.js" type="text/javascript"></script>
<script src="js/Leaflet.PolylineMeasure.js" type="text/javascript"></script>
<script src="js/Control.MiniMap.js" type="text/javascript"></script>
<script src="js/leaflet-geoman.js" type="text/javascript"></script>
<script src="js/leaflet.awesome-markers.js" type="text/javascript"></script>
<script src="js/dom-to-image-more.js" type="text/javascript"></script>
<script src="js/jspdf-2.5.1.umd.js" type="text/javascript"></script>
<script src="js/jExportMap.js" type="text/javascript"></script>
</link></head>
<body>
<button class="ui icon button" id="toggleExportBtn" style="position: absolute; top: 120px; right: 5px; z-index: 1001;">
<i class="download icon"></i>
</button>
<button class="ui icon button" id="addRouteBtn" style="position: absolute; top: 160px; right: 5px; z-index: 1001;">
<i class="plus icon"></i>
</button>
<div>
<div class="ui segment" id="exportmapseg">
<table style="width:100%;">
<tbody>
<tr>
<td style="width:75px;">é é¢å¤§å°</td>
<td>
<select class="ui fluid dropdown" id="format">
<option value="a0">A0 (slow)</option>
<option value="a1">A1</option>
<option value="a2">A2</option>
<option value="a3">A3</option>
<option selected="" value="a4">A4</option>
<option value="a5">A5 (fast)</option>
</select>
</td>
</tr>
<tr>
<td>è§£æåº¦</td>
<td>
<select class="ui fluid dropdown" id="resolution">
<option value="72">72 dpi (fast)</option>
<option value="150">150 dpi</option>
<option selected="" value="200">200 dpi</option>
<option value="300">300 dpi (slow)</option>
</select>
</td>
</tr>
<tr>
<td>æ¯”ä¾‹å°º</td>
<td>
<select class="ui fluid dropdown" id="pscale">
<option value="500">1:500000</option>
<option selected="" value="250">1:250000</option>
<option value="100">1:100000</option>
<option value="50">1:50000</option>
<option value="25">1:25000</option>
<option value="10">1:10000</option>
</select>
</td>
</tr>
<tr>
<td>è¼¸å‡ºæ ¼å¼</td>
<td>
<select class="ui fluid dropdown" id="imageformat">
<option selected="" value="PNG">PNG</option>
<option value="JPEG">JPEG</option>
<option value="PDF">PDF</option>
</select>
</td>
</tr>
</tbody>
</table>
<button class="fluid ui primary basic button" id="exportMapBtn" onclick="exportmap.WebMapExport()" style="margin-top:10px;" type="button" value="export">è¼¸å‡º</button>
</div>
</div>
<script>
			// åƒè€ƒä¾†æºï¼šhttps://ithelp.ithome.com.tw/users/20108631/ironman/3629
			// åƒè€ƒä¾†æºï¼šhttps://ithelp.ithome.com.tw/users/20107816/ironman/1541
			$(document).ready(function() {
				$('.ui.dropdown').dropdown();
			});
		</script>
<div id="map"></div>
<div class="toolbar">
<input id="coord-input" placeholder="è¼¸å…¥åº§æ¨™: 25.03,121.56" type="text"/>
<button onclick="searchCoords()">ğŸ” æœå°‹åº§æ¨™</button>
</div>
<script>
			document.addEventListener("DOMContentLoaded", function() {
				window.coords = [];
				<!-- window.routes = []; -->
				window.currentRouteIndex = -1;


				// é è¨­ä½ç½®
				const defaultCenter = [24.439043218408983, 121.7528521305105];
				window.map = L.map("map").setView(defaultCenter, 16);
				map.on("mousemove", function(e) {
					const lat = e.latlng.lat.toFixed(6);
					const lng = e.latlng.lng.toFixed(6);
					const coordDiv = document.getElementById("wgs84-coords");
					if (coordDiv) {
						coordDiv.textContent = `åº§æ¨™ï¼š${lat}, ${lng}`;
					}
				});
				// ä½¿ç”¨è€…ä½ç½®
				const userMarker = L.marker(defaultCenter).addTo(map).bindPopup("é è¨­ä¸­å¿ƒé»").openPopup();
				const userPosDiv = L.DomUtil.create('div', 'mouse-position');
				userPosDiv.style.marginBottom = '5px';
				userPosDiv.style.fontWeight = 'bold';
				// userPosDiv.innerHTML = "ä½¿ç”¨è€…åº§æ¨™ï¼šç„¡æ³•å–å¾—";
				const userPosControl = L.control({ position: 'bottomleft' });
				userPosControl.onAdd = () => userPosDiv;
				userPosControl.addTo(map);

				function locateUser() {
					if (navigator.geolocation) {
						if (window.isSecureContext) {
							navigator.geolocation.getCurrentPosition(function(pos) {
								const lat = pos.coords.latitude;
								const lng = pos.coords.longitude;
								// userPosDiv.innerHTML = `ä½¿ç”¨è€…åº§æ¨™ï¼š${lat.toFixed(6)}, ${lng.toFixed(6)}`;
								map.setView([lat, lng], 16);
								userMarker.setLatLng([lat, lng]).bindPopup("ğŸ“ ä½¿ç”¨è€…ä½ç½®").openPopup();
							}, function(err) {
								console.warn(`ç„¡æ³•å–å¾—å®šä½: ${err.message}`);
								showMessage("âš ï¸ ç„¡æ³•å–å¾—å®šä½ï¼Œä½¿ç”¨é è¨­ä½ç½®");
							}, {
								enableHighAccuracy: true,
								timeout: 5000,
								maximumAge: 0
							});
						} else {
							showMessage("âš ï¸ å®šä½åŠŸèƒ½é ˆ HTTPS æˆ– localhost ç’°å¢ƒ");
						}
					} else {
						showMessage("âš ï¸ ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
					}
				}
				
				locateUser();

				// é è¨­åœ–å±¤
				baseLayers['è‡ºç£é€šç”¨é›»å­åœ°åœ–'].addTo(map);
				// åŠ å…¥åœ–å±¤
				L.control.layers(baseLayers).addTo(map);

				// ä»¥ä¸‹é–‹å§‹ç‚ºå„ç¨®å¤–æ›

				// è¿½åŠ  ICON
				function addMarker(Lat, Lng, Icon, Prefix, MarkerColor, IconColor, Spin) {
					const marker = L.marker([Lat, Lng], {
						icon: L.AwesomeMarkers.icon({
							icon: Icon || 'info', 
							prefix: Prefix || 'fa', 
							markerColor: MarkerColor || 'blue', 
							iconColor: IconColor || 'white', 
							spin: Spin || false}) 
						}).addTo(map);
					return marker;
				}
				// ICON è¿½åŠ æ–¹å¼
				addMarker(25.009237, 121.464342, 'link', 'glyphicon', 'red', '', true);

				// åŠ å…¥æ¯”ä¾‹å°º
				L.control.scale().addTo(map); 
				
				// å®šä½ä½¿ç”¨è€…åº§æ¨™
				lc = L.control.locate({strings: {title: "Show me where I am, yo!"}}).addTo(map);
				// å³ä¸‹è§’å°åœ°åœ–(ä¸èƒ½èˆ‡ä¸»åœ°åœ–ç›¸åŒ)
				var osm2 = baseLayers['æ­£å°„å½±åƒåœ–(é€šç”¨)'];
				var miniMap = new L.Control.MiniMap(osm2, { toggleDisplay: true }).addTo(map);
				// åŒ¯å‡ºå¤§åœ–
				L.control.bigImage({position: 'topright'}).addTo(map);
				// è·é›¢é‡æ¸¬
				options = {
					position: 'topleft',            // Position to show the control. Values: 'topright', 'topleft', 'bottomright', 'bottomleft'
					unit: 'kilometres',             // Default unit the distances are displayed in. Values: 'kilometres', 'landmiles', 'nauticalmiles'
					useSubunits: true,              // Use subunits (metres/feet) in tooltips if distances are less than 1 kilometre/landmile
					clearMeasurementsOnStop: true,  // Clear all measurements when Measure Control is switched off
					showBearings: false,            // Whether bearings are displayed within the tooltips
					bearingTextIn: 'In',            // language dependend label for inbound bearings
					bearingTextOut: 'Out',          // language dependend label for outbound bearings
					tooltipTextFinish: 'Click to <b>finish line</b><br>',
					tooltipTextDelete: 'Press SHIFT-key and click to <b>delete point</b>',
					tooltipTextMove: 'Click and drag to <b>move point</b><br>',
					tooltipTextResume: '<br>Press CTRL-key and click to <b>resume line</b>',
					tooltipTextAdd: 'Press CTRL-key and click to <b>add point</b>',
													// language dependend labels for point's tooltips
					measureControlTitleOn: 'Turn on PolylineMeasure',   // Title for the Measure Control going to be switched on
					measureControlTitleOff: 'Turn off PolylineMeasure', // Title for the Measure Control going to be switched off
					measureControlLabel: '&#8614;', // Label of the Measure Control (Unicode symbols are possible)
					measureControlClasses: [],      // Classes to apply to the Measure Control
					showClearControl: true,        // Show a control to clear all the measurements
					clearControlTitle: 'Clear Measurements', // Title text to show on the Clear Control
					clearControlLabel: '&times',    // Label of the Clear Control (Unicode symbols are possible)
					clearControlClasses: [],        // Classes to apply to Clear Control
					showUnitControl: false,         // Show a control to change the units of measurements
					unitControlUnits: ["kilometres", "landmiles", "nauticalmiles"],
													// measurement units being cycled through by using the Unit Control
					unitControlTitle: {             // Title texts to show on the Unit Control
						text: 'Change Units',
						kilometres: 'kilometres',
						landmiles: 'land miles',
						nauticalmiles: 'nautical miles'
					},
					unitControlLabel: {             // Unit symbols to show in the Unit Control and measurement labels
						metres: 'm',
						kilometres: 'km',
						feet: 'ft',
						landmiles: 'mi',
						nauticalmiles: 'nm'
					},
					unitControlClasses: [],         // Classes to apply to the Unit Control
					tempLine: {                     // Styling settings for the temporary dashed line
						color: '#00f',              // Dashed line color
						weight: 2                   // Dashed line weight
					},          
					fixedLine: {                    // Styling for the solid line
						color: '#006',              // Solid line color
						weight: 2                   // Solid line weight
					},
					arrow: {                        // Styling of the midway arrow 
						color: '#000',              // Color of the arrow
					},
					startCircle: {                  // Style settings for circle marker indicating the starting point of the polyline
						color: '#000',              // Color of the border of the circle
						weight: 1,                  // Weight of the circle
						fillColor: '#0f0',          // Fill color of the circle
						fillOpacity: 1,             // Fill opacity of the circle
						radius: 3                   // Radius of the circle
					},
					intermedCircle: {               // Style settings for all circle markers between startCircle and endCircle
						color: '#000',              // Color of the border of the circle
						weight: 1,                  // Weight of the circle
						fillColor: '#ff0',          // Fill color of the circle
						fillOpacity: 1,             // Fill opacity of the circle
						radius: 3                   // Radius of the circle
					},
					currentCircle: {                // Style settings for circle marker indicating the latest point of the polyline during drawing a line
						color: '#000',              // Color of the border of the circle
						weight: 1,                  // Weight of the circle
						fillColor: '#f0f',          // Fill color of the circle
						fillOpacity: 1,             // Fill opacity of the circle
						radius: 6                   // Radius of the circle
					},
					endCircle: {                    // Style settings for circle marker indicating the last point of the polyline
						color: '#000',              // Color of the border of the circle
						weight: 1,                  // Weight of the circle
						fillColor: '#f00',          // Fill color of the circle
						fillOpacity: 1,             // Fill opacity of the circle
						radius: 3                   // Radius of the circle
					},
				};

				L.control.polylineMeasure(options).addTo(map);

				map.pm.addControls({  
					position: 'topleft',  
					drawCircleMarker: false,
					rotateMode: false,
					}); 

				const MousePosition = L.Control.extend({
					onAdd: function(map) {
						this._div = L.DomUtil.create('div', 'mouse-position');
						this.update();
						map.on('mousemove', this._onMouseMove, this);
						return this._div;
					},
					onRemove: function(map) {
						map.off('mousemove', this._onMouseMove, this);
					},
					_onMouseMove: function(e) {
						this.update(e.latlng);
					},
					update: function(latlng) {
						if (!latlng) {
							this._div.innerHTML = 'åº§æ¨™ï¼šæ»‘é¼ ç§»å…¥åœ°åœ–';
							return;
						}
						this._div.innerHTML = `åº§æ¨™ï¼š${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
					}
				});

				const mousePositionControl = new MousePosition({position: 'bottomleft'}).addTo(map);

				function showMessage(msg) {
					userMarker.bindPopup(msg).openPopup();
				}
				
				window.searchCoords = function() {
					const input = document.getElementById('coord-input').value.trim();
					if (!input) {
						alert("è«‹è¼¸å…¥åº§æ¨™");
						return;
					}
					const parts = input.split(',');
					if (parts.length !== 2) {
						alert("æ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥ç¶“ç·¯åº¦æ ¼å¼: lat,lng");
						return;
					}
					const lat = parseFloat(parts[0]);
					const lng = parseFloat(parts[1]);
					if (isNaN(lat) || isNaN(lng)) {
						alert("ç¶“ç·¯åº¦å¿…é ˆæ˜¯æ•¸å­—");
						return;
					}
					map.setView([lat, lng], 16);
					userMarker.setLatLng([lat, lng]).bindPopup("ğŸ” æœå°‹åº§æ¨™").openPopup();
				};
				
				// Define projections
				proj4.defs("EPSG:3826", "+proj=tmerc +lat_0=0 +lon_0=121 +k=0.9999 +x_0=250000 +y_0=0 +ellps=GRS80 +units=m +no_defs");
				proj4.defs("EPSG:3828", "+proj=tmerc +lat_0=0 +lon_0=121 +k=0.9999 +x_0=250000 +y_0=0 +ellps=clrk66 +units=m +no_defs");
				let marker;
				map.on("click", function(e) {
					const latlng = e.latlng;
					const wgs84 = [latlng.lng, latlng.lat];
					const twd97 = proj4("EPSG:4326", "EPSG:3826", wgs84);
					const twd67 = proj4("EPSG:4326", "EPSG:3828", wgs84);
					const popupContent = `
								<b>åº§æ¨™æ ¼å¼ï¼š<\/b>
							<br>
								<button onclick="copyText('${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}')">WGS84: ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}<\/button>
								<br>
									<button onclick="copyText('${twd97[1].toFixed(2)}, ${twd97[0].toFixed(2)}')">TWD97: ${twd97[1].toFixed(2)}, ${twd97[0].toFixed(2)}<\/button>
									<br>
										<button onclick="copyText('${twd67[1].toFixed(2)}, ${twd67[0].toFixed(2)}')">TWD67: ${twd67[1].toFixed(2)}, ${twd67[0].toFixed(2)}<\/button>
							`;
					if (marker) {
						marker.setLatLng(latlng).setPopupContent(popupContent).openPopup();
					} else {
						marker = L.marker(latlng).addTo(map).bindPopup(popupContent).openPopup();
					}
				});
				
				window.copyText = function(text) {
					navigator.clipboard.writeText(text).then(() => {
						alert("å·²è¤‡è£½åº§æ¨™ï¼š" + text);
					}).catch(err => {
						alert("è¤‡è£½å¤±æ•—ï¼š" + err);
					});
				};
			});
		</script>
<script>
            $(document).ready(function() {
                $('#toggleExportBtn').on('click', function() {
                    $('#exportmapseg').toggle();
                });
            });
		</script>
<!-- Route Manager UI -->
<div id="route-manager" style="display:none; position:absolute; top:60px; right:120px; z-index:1000; background:#fff; padding:10px; border:1px solid #ccc; width:300px;">
  <!-- éš±è—æŒ‰éˆ• -->
  <button id="hideRouteManagerBtn" class="ui mini red button" style="float:right;">âœ–ï¸ é—œé–‰</button>

  <div style="clear:both;"></div> <!-- è®“å…§å®¹ä¸æœƒè¢« float å½±éŸ¿ -->

  <div id="routeInfo" style="margin-top:10px;"></div>

  <div style="margin-top:20px;">
    <h3>å¤šè·¯ç·šç®¡ç†</h3>
    <select id="routeList" onchange="switchRoute()"></select>
    <button onclick="createNewRoute()">æ–°å¢</button>
    <button onclick="deleteRoute()">åˆªé™¤</button>
    <button onclick="renameRoute()">é‡æ–°å‘½å</button>
  </div>

  <h4>è·¯ç·šç®¡ç†</h4>
  <div>
    <label>åº§æ¨™ç³»çµ±ï¼š</label>
    <label><input type="radio" name="coordType" value="TWD67" />TWD67</label>
    <label><input type="radio" name="coordType" value="TWD97" checked />TWD97</label>
    <label><input type="radio" name="coordType" value="WGS84" />WGS84</label>
  </div>

  <div>
    <input id="coordInput" type="text" placeholder="lat,lng" style="width:100%;" />
    <button id="addCoordBtn">åŠ å…¥åº§æ¨™</button>
  </div>

  <ul id="coordList" style="max-height:150px; overflow-y:auto; padding-left:20px;"></ul>

  <div>
    <button id="clearCoordsBtn">å–æ¶ˆ</button>
    <button id="confirmRouteBtn">ç¢ºå®š</button>
  </div>
</div>

<script>
            document.getElementById("addRouteBtn").addEventListener("click", () => {
			const routeManager = document.getElementById("route-manager");
			const isVisible = routeManager.style.display === "block";

			if (!isVisible) {
				// é–‹å•Ÿ route-manager
				routeManager.style.display = "block";

				// å–å¾—ç›®å‰é¸æ“‡çš„è·¯ç·šåç¨±
				const selected = document.getElementById('routeList').value;
				if (selected && routes[selected] && routes[selected].coords && routes[selected].coords.length > 0) {
				// è‹¥æœ‰åº§æ¨™ï¼ŒåŸ·è¡Œ switchRoute() é‡æ–°æ¸²æŸ“
				switchRoute();
				}
			} else {
				// å¦‚æœå·²ç¶“é–‹å•Ÿï¼Œå‰‡æ”¶èµ·
				routeManager.style.display = "none";
			}
			});


			// æ–°å¢çš„é—œé–‰æŒ‰éˆ•åŠŸèƒ½
			document.getElementById("hideRouteManagerBtn").addEventListener("click", () => {
				document.getElementById("route-manager").style.display = "none";
			});

			
			document.getElementById("addCoordBtn").addEventListener("click", () => {
  const coordInput = document.getElementById("coordInput");
  const coordList = document.getElementById("coordList");
  const value = coordInput.value.trim();
  if (!value.match(/^[-+]?\d+(\.\d+)?\s*,\s*[-+]?\d+(\.\d+)?$/)) return alert("è«‹è¼¸å…¥æœ‰æ•ˆåº§æ¨™");

  const [lat, lng] = value.split(",").map(Number);
  const coordType = document.querySelector("input[name='coordType']:checked").value;

  const item = document.createElement("li");
  item.textContent = `${coordType}: ${lat}, ${lng}`;

  const delBtn = document.createElement("button");
  delBtn.textContent = "ğŸ—‘ï¸";
  delBtn.style.marginLeft = "10px";
  const coord = { lat, lng, type: coordType };

  delBtn.onclick = () => {
    coordList.removeChild(item);
    coords = coords.filter(c => c !== coord);
    // å›å­˜
    if (currentRoute) {
      routes[currentRoute].coords = coords;
      saveRoutesToStorage();
    }
    updateRoute();
  };

  item.appendChild(delBtn);
  coordList.appendChild(item);

  coords.push(coord);

  // âœ… å›å­˜åˆ°ç›®å‰è·¯ç·š
  if (currentRoute) {
    routes[currentRoute].coords = coords;
    saveRoutesToStorage();
  }

  coordInput.value = "";
  updateRoute();
});

		
			document.getElementById("clearCoordsBtn").addEventListener("click", () => {
				coords = [];
				document.getElementById("coordList").innerHTML = "";
				updateRoute();
			});
		
			document.getElementById("confirmRouteBtn").addEventListener("click", () => {
				const name = document.getElementById("routeList").value.trim();
				if (!name) return alert("è«‹è¼¸å…¥è·¯ç·šåç¨±");
				
				const newRoute = {
					name: name,
					coords: [...coords],
					layer: null,
					markers: []
				};
				
                routes[name] = newRoute;
                currentRoute = name;
                updateRoute(true);
                alert("å·²æ–°å¢è·¯ç·šï¼š" + name);

			});
		
			function convertToWGS84(coord) {
				if (coord.type === "WGS84") return [coord.lng, coord.lat];
				const projDefs = {
					TWD67: "+proj=tmerc +lat_0=0 +lon_0=121 +k=0.9999 +x_0=250000 +y_0=0 +ellps=clrk66 +units=m +no_defs",
					TWD97: "+proj=tmerc +lat_0=0 +lon_0=121 +k=0.9999 +x_0=250000 +y_0=0 +ellps=GRS80 +units=m +no_defs"
				};
				
				const proj = proj4(projDefs[coord.type], proj4.WGS84);
				return proj.forward([coord.lng, coord.lat]);
			}
		
			function updateRoute(draw = false) {
				const routeInfo = document.getElementById("routeInfo");
				if (!draw || coords.length < 2) {
					routeInfo.textContent = "";
					return;
				}
				
				const latlngs = coords.map(convertToWGS84).map(([lng, lat]) => [lat, lng]);
				if (window.routeLayer) map.removeLayer(window.routeLayer);
				if (window.routeMarkers) window.routeMarkers.forEach(m => map.removeLayer(m));
				window.routeMarkers = latlngs.map((latlng, i) => {
					const color = i === 0 ? "green" : (i === latlngs.length - 1 ? "red" : "black");
					return L.circleMarker(latlng, { radius: 6, color }).addTo(map);
				});
				
				window.routeLayer = L.polyline(latlngs, { color: "blue" }).addTo(map);
				map.fitBounds(window.routeLayer.getBounds());
				const dist = latlngs.reduce((sum, cur, i, arr) => {
					if (i === 0) return 0;
					return sum + map.distance(arr[i - 1], cur);
				}, 0);
				
				routeInfo.textContent = `ç¸½é•·åº¦ï¼š${(dist / 1000).toFixed(2)} å…¬é‡Œ`;
			}
		</script>
</body>
<script>
		let routes = {};
		let currentRoute = null;

		function saveRoutesToStorage() {
			localStorage.setItem('routes', JSON.stringify(routes));
		}

		function loadRoutesFromStorage() {
			const stored = localStorage.getItem('routes');
			if (stored) {
				routes = JSON.parse(stored);
				updateRouteListUI();
			}
		}

		function updateRouteListUI() {
			const list = document.getElementById('routeList');
			list.innerHTML = '';
			for (let name in routes) {
				const option = document.createElement('option');
				option.value = name;
				option.textContent = name;
				list.appendChild(option);
			}
		}

		function createNewRoute() {
			const name = prompt('Enter new route name:');
			if (name && !routes[name]) {
				routes[name] = {
					name: name,
					coords: [],
					layer: null,
					markers: []
				};
				currentRoute = name;
				coords = []; // é‡è¨­ç•¶å‰è·¯ç·šåº§æ¨™

				// æ¸…ç©º UI è·¯ç·šåˆ—è¡¨ä¸¦è¨­å®šç‚ºæ–°è·¯ç·š
				updateRouteListUI();
				document.getElementById('routeList').value = name;

				// æ¸…ç©ºåœ°åœ–ä¸Šçš„æ—¢æœ‰åœ–å±¤èˆ‡æ¨™è¨˜
				if (window.routeLayer) {
					map.removeLayer(window.routeLayer);
					window.routeLayer = null;
				}
				if (window.routeMarkers && window.routeMarkers.length) {
					window.routeMarkers.forEach(m => map.removeLayer(m));
					window.routeMarkers = [];
				}
				document.getElementById("routeInfo").textContent = "";
				document.getElementById("coordList").innerHTML = "";

				saveRoutesToStorage();
				alert('New route created: ' + name);
			} else {
				alert('Invalid or duplicate route name.');
			}
		}


		function switchRoute() {
			const selected = document.getElementById('routeList').value;
			if (selected && routes[selected]) {
				currentRoute = selected;
				coords = routes[selected].coords || [];

				const coordList = document.getElementById("coordList");
				coordList.innerHTML = "";

				if (coords.length > 0) {
					coords.forEach(coord => {
						const item = document.createElement("li");
						item.textContent = `${coord.type}: ${coord.lat}, ${coord.lng}`;

						const delBtn = document.createElement("button");
						delBtn.textContent = "ğŸ—‘ï¸";
						delBtn.style.marginLeft = "10px";
						delBtn.onclick = () => {
							coordList.removeChild(item);
							coords = coords.filter(c => c !== coord);
							updateRoute();
						};

						item.appendChild(delBtn);
						coordList.appendChild(item);
					});

					updateRoute(true);
				} else {
					// å¦‚æœæ²’æœ‰åº§æ¨™ï¼Œæ¸…ç©ºåœ–å±¤èˆ‡æ¨™è¨˜
					if (window.routeLayer) {
						map.removeLayer(window.routeLayer);
						window.routeLayer = null;
					}
					if (window.routeMarkers && window.routeMarkers.length) {
						window.routeMarkers.forEach(m => map.removeLayer(m));
						window.routeMarkers = [];
					}
					document.getElementById("routeInfo").textContent = "";
				}

				alert('å·²åˆ‡æ›åˆ°è·¯ç·š: ' + selected);
			} else {
				alert('æ‰¾ä¸åˆ°é¸æ“‡çš„è·¯ç·šã€‚');
			}
		}



		function deleteRoute() {
			const selected = document.getElementById('routeList').value;
			if (selected && confirm('Delete route: ' + selected + '?')) {
				delete routes[selected];
				currentRoute = null;
				updateRouteListUI();
				saveRoutesToStorage();
				alert('Route deleted.');
			}
		}

		function renameRoute() {
			const selected = document.getElementById('routeList').value;
			const newName = prompt('Enter new name for route: ' + selected);
			if (newName && !routes[newName]) {
				routes[newName] = routes[selected];
				delete routes[selected];
				currentRoute = newName;
				updateRouteListUI();
				document.getElementById('routeList').value = newName;
				saveRoutesToStorage();
				alert('Route renamed to: ' + newName);
			} else {
				alert('Invalid or duplicate new name.');
			}
		}

		window.onload = function() {
			loadRoutesFromStorage();
		};
	</script>
</html>
