<!DOCTYPE html>
<html>
<head>
	<title>åœ°åœ–</title>
	<meta charset="utf-8">
	<meta content="width=device-width, initial-scale=1" name="viewport">
	<link href="css/leaflet.css" rel="stylesheet">
	<style>
	html, body, #map {
		height: 100%;
		margin: 0;
		padding: 0;
	}
	.mouse-position {
		padding: 5px 10px;
		background: rgba(255, 255, 255, 0.8);
		font-size: 14px;
		font-family: Arial, sans-serif;
	}
	.toolbar {
		position: absolute;
		top: 10px;
		left: 50%;
		transform: translateX(-50%);
		background: rgba(255, 255, 255, 0.9);
		padding: 8px 12px;
		border-radius: 5px;
		box-shadow: 0 0 8px rgba(0, 0, 0, 0.2);
		z-index: 1000;
		font-family: Arial, sans-serif;
	}
	.toolbar input {
		width: 180px;
		padding: 4px 6px;
		margin-right: 6px;
		font-size: 14px;
	}
	.toolbar button {
		padding: 5px 10px;
		font-size: 14px;
		cursor: pointer;
	}
	</style>
	<link rel="stylesheet" href="css/L.Control.Locate.min.css" />
	<script src="js/proj4-2.19.3-src.js"></script>
	<link re="stylesheet" href="css/Leaflet.BigImage.min.css" />
</head>
<body>
	<div id="map"></div>
	<div class="toolbar">
		<input id="coord-input" placeholder="è¼¸å…¥åº§æ¨™: 25.03,121.56" type="text">
		<button onclick="searchCoords()">ğŸ” æœå°‹åº§æ¨™</button>
		<button onclick="locateUser()">ğŸ“ å›åˆ°å®šä½</button>
	</div>
	<script src="js/leaflet-1.9.3-src.js"></script> 
	<script src="js/baseLayers2.js"></script> 
	<script src="js/L.Control.Locate.min.js"></script>
	<script src="js/bundle.js"></script>
	<script src="js/Leaflet.BigImage.min.js"></script>
	<script>
		document.addEventListener("DOMContentLoaded", function() {
			
			// é è¨­ä½ç½®
			const defaultCenter = [24.439043218408983, 121.7528521305105];
			window.map = L.map("map").setView(defaultCenter, 16);
			map.on("mousemove", function(e) {
				const lat = e.latlng.lat.toFixed(6);
				const lng = e.latlng.lng.toFixed(6);
				const coordDiv = document.getElementById("wgs84-coords");
				if (coordDiv) {
					coordDiv.textContent = `åº§æ¨™ï¼š${lat}, ${lng}`;
				}
			});
			// é è¨­åœ–å±¤
			baseLayers['è‡ºç£é€šç”¨é›»å­åœ°åœ–'].addTo(map);
			// åŠ å…¥åœ–å±¤
			L.control.layers(baseLayers).addTo(map);
			// åŠ å…¥æ¯”ä¾‹å°º
			L.control.scale().addTo(map); 
			
			// å®šä½ä½¿ç”¨è€…åº§æ¨™
			lc = L.control.locate({strings: {title: "Show me where I am, yo!"}}).addTo(map);

			L.control.bigImage({position: 'topright'}).addTo(map);

			
			var tiles = baseLayers['è‡ºç£é€šç”¨é›»å­åœ°åœ–'];
			var printer = L.easyPrint({
				tileLayer: tiles,
				sizeModes: ['Current', 'A4Landscape', 'A4Portrait'],
				filename: 'myMap',
				exportOnly: true,
				hideControlContainer: true
			}).addTo(map);

			function manualPrint () {
				printer.printMap('CurrentSize', 'MyManualPrint')
			}

			const userMarker = L.marker(defaultCenter).addTo(map).bindPopup("é è¨­ä¸­å¿ƒé»").openPopup();

			const MousePosition = L.Control.extend({
				onAdd: function(map) {
					this._div = L.DomUtil.create('div', 'mouse-position');
					this.update();
					map.on('mousemove', this._onMouseMove, this);
					return this._div;
				},
				onRemove: function(map) {
					map.off('mousemove', this._onMouseMove, this);
				},
				_onMouseMove: function(e) {
					this.update(e.latlng);
				},
				update: function(latlng) {
					if (!latlng) {
						this._div.innerHTML = 'åº§æ¨™ï¼šæ»‘é¼ ç§»å…¥åœ°åœ–';
						return;
					}
					this._div.innerHTML = `åº§æ¨™ï¼š${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
				}
			});
			const mousePositionControl = new MousePosition({
				position: 'bottomleft'
			});
			mousePositionControl.addTo(map);

			function showMessage(msg) {
				userMarker.bindPopup(msg).openPopup();
			}

			window.searchCoords = function() {
				const input = document.getElementById('coord-input').value.trim();
				if (!input) {
					alert("è«‹è¼¸å…¥åº§æ¨™");
					return;
				}
				const parts = input.split(',');
				if (parts.length !== 2) {
					alert("æ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥ç¶“ç·¯åº¦æ ¼å¼: lat,lng");
					return;
				}
				const lat = parseFloat(parts[0]);
				const lng = parseFloat(parts[1]);
				if (isNaN(lat) || isNaN(lng)) {
					alert("ç¶“ç·¯åº¦å¿…é ˆæ˜¯æ•¸å­—");
					return;
				}
				map.setView([lat, lng], 16);
				userMarker.setLatLng([lat, lng]).bindPopup("ğŸ” æœå°‹åº§æ¨™").openPopup();
			};
			
			// Define projections
			proj4.defs("EPSG:3826", "+proj=tmerc +lat_0=0 +lon_0=121 +k=0.9999 +x_0=250000 +y_0=0 +ellps=GRS80 +units=m +no_defs");
			proj4.defs("EPSG:3828", "+proj=tmerc +lat_0=0 +lon_0=121 +k=0.9999 +x_0=250000 +y_0=0 +ellps=clrk66 +units=m +no_defs");
			let marker;
			map.on("click", function(e) {
				const latlng = e.latlng;
				const wgs84 = [latlng.lng, latlng.lat];
				const twd97 = proj4("EPSG:4326", "EPSG:3826", wgs84);
				const twd67 = proj4("EPSG:4326", "EPSG:3828", wgs84);
				const popupContent = `
							  <b>åº§æ¨™æ ¼å¼ï¼š<\/b>
						  <br>
							  <button onclick="copyText('${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}')">WGS84: ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}<\/button>
							  <br>
								  <button onclick="copyText('${twd97[1].toFixed(2)}, ${twd97[0].toFixed(2)}')">TWD97: ${twd97[1].toFixed(2)}, ${twd97[0].toFixed(2)}<\/button>
								  <br>
									  <button onclick="copyText('${twd67[1].toFixed(2)}, ${twd67[0].toFixed(2)}')">TWD67: ${twd67[1].toFixed(2)}, ${twd67[0].toFixed(2)}<\/button>
						  `;
				if (marker) {
					marker.setLatLng(latlng).setPopupContent(popupContent).openPopup();
				} else {
					marker = L.marker(latlng).addTo(map).bindPopup(popupContent).openPopup();
				}
			});
			
			window.copyText = function(text) {
				navigator.clipboard.writeText(text).then(() => {
					alert("å·²è¤‡è£½åº§æ¨™ï¼š" + text);
				}).catch(err => {
					alert("è¤‡è£½å¤±æ•—ï¼š" + err);
				});
			};
			
			
		});
		
		
	</script>
</body>
</html>